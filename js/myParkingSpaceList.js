var dataset_myParkingSpaceHistory = [
    {
        'paymentDate': '2024-06-28',
        'carType': '汽車',
        'parkingSpaceNum': 'B4-30',
        'name': '陳凱富',
        'licensePlateNum': '0869-RE',
        'endDate': '2024-07-18',
        'remark': '-',
        'id': '1',
        'jobTitle': '經理',
        'ext': '123',
        'phone': '02-86710869',
        'email': 'chenkaifu@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2023-08-20',
        'carType': '機車',
        'parkingSpaceNum': 'B5-1',
        'name': '陳昭嫺',
        'licensePlateNum': 'X-8470',
        'endDate': '2024-09-01',
        'remark': '-',
        'id': '2',
        'jobTitle': '工程師',
        'ext': '456',
        'phone': '0912-345678',
        'email': 'chenzhaoxian@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-04-18',
        'carType': '汽車',
        'parkingSpaceNum': 'B6-12',
        'name': '林雅惠',
        'licensePlateNum': '4823-JF',
        'endDate': '2024-05-18',
        'remark': '已到期且未續約。',
        'id': '3',
        'jobTitle': '分析師',
        'ext': '789',
        'phone': '02-86714823',
        'email': 'linyahuei@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-05-15',
        'carType': '機車',
        'parkingSpaceNum': 'B7-5',
        'name': '張文成',
        'licensePlateNum': '2-9685',
        'endDate': '2024-06-17',
        'remark': '-',
        'id': '4',
        'jobTitle': '主任',
        'ext': '112',
        'phone': '0912-346789',
        'email': 'zhangwencheng@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-04-30',
        'carType': '汽車',
        'parkingSpaceNum': 'B8-21',
        'name': '許美玲',
        'licensePlateNum': '7219-LK',
        'endDate': '2024-05-30',
        'remark': '-',
        'id': '5',
        'jobTitle': '助理',
        'ext': '-',
        'phone': '02-86717219',
        'email': 'hsiumeiling@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-06-02',
        'carType': '機車',
        'parkingSpaceNum': 'B9-8',
        'name': '黃佩樺',
        'licensePlateNum': '7-Y245',
        'endDate': '2024-07-02',
        'remark': '快到期，請盡速續約。',
        'id': '6',
        'jobTitle': '專員',
        'ext': '321',
        'phone': '0912-347890',
        'email': 'huangpeihua@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-06-05',
        'carType': '汽車',
        'parkingSpaceNum': 'B10-18',
        'name': '劉建宏',
        'licensePlateNum': '5390-ZP',
        'endDate': '2024-07-05',
        'remark': '快到期，請盡速續約。',
        'id': '7',
        'jobTitle': '經理',
        'ext': '654',
        'phone': '02-86715390',
        'email': 'liujianhong@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-06-01',
        'carType': '機車',
        'parkingSpaceNum': 'B11-3',
        'name': '吳明憲',
        'licensePlateNum': '9-5012',
        'endDate': '2024-07-01',
        'remark': '快到期，請盡速續約。',
        'id': '8',
        'jobTitle': '主任',
        'ext': '987',
        'phone': '0912-348901',
        'email': 'wumingxian@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-05-26',
        'carType': '汽車',
        'parkingSpaceNum': 'B12-9',
        'name': '蔡淑芬',
        'licensePlateNum': '4825-NX',
        'endDate': '2024-06-23',
        'remark': '-',
        'id': '9',
        'jobTitle': '分析師',
        'ext': '234',
        'phone': '02-86714825',
        'email': 'caishufen@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-05-15',
        'carType': '機車',
        'parkingSpaceNum': 'B13-6',
        'name': '陳芳儀',
        'licensePlateNum': '6-X084',
        'endDate': '2024-06-26',
        'remark': '-',
        'id': '10',
        'jobTitle': '工程師',
        'ext': '567',
        'phone': '0912-349012',
        'email': 'chenfangyi@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-05-09',
        'carType': '汽車',
        'parkingSpaceNum': 'B14-28',
        'name': '葉文祥',
        'licensePlateNum': '1265-DK',
        'endDate': '2024-06-26',
        'remark': '-',
        'id': '11',
        'jobTitle': '助理',
        'ext': '890',
        'phone': '02-86711265',
        'email': 'yewenxiang@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-05-18',
        'carType': '機車',
        'parkingSpaceNum': 'B15-10',
        'name': '劉惠珍',
        'licensePlateNum': '3-L769',
        'endDate': '2024-06-18',
        'remark': '-',
        'id': '12',
        'jobTitle': '專員',
        'ext': '123',
        'phone': '0912-341234',
        'email': 'liuhuizhen@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2025-01-25',
        'carType': '汽車',
        'parkingSpaceNum': 'B16-15',
        'name': '林秋美',
        'licensePlateNum': '9274-BH',
        'endDate': '2025-02-25',
        'remark': '-',
        'id': '13',
        'jobTitle': '經理',
        'ext': '456',
        'phone': '02-86719274',
        'email': 'linqiumei@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2025-02-14',
        'carType': '機車',
        'parkingSpaceNum': 'B17-2',
        'name': '張雅婷',
        'licensePlateNum': '7-V821',
        'endDate': '2025-03-14',
        'remark': '-',
        'id': '14',
        'jobTitle': '主任',
        'ext': '789',
        'phone': '0912-342345',
        'email': 'zhangyating@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2025-03-08',
        'carType': '汽車',
        'parkingSpaceNum': 'B18-25',
        'name': '郭大偉',
        'licensePlateNum': '6841-MG',
        'endDate': '2025-04-08',
        'remark': '-',
        'id': '15',
        'jobTitle': '工程師',
        'ext': '112',
        'phone': '02-86716841',
        'email': 'guodawei@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2025-04-22',
        'carType': '機車',
        'parkingSpaceNum': 'B19-4',
        'name': '陳志明',
        'licensePlateNum': '1-Q525',
        'endDate': '2025-05-22',
        'remark': '-',
        'id': '16',
        'jobTitle': '助理',
        'ext': '345',
        'phone': '0912-343456',
        'email': 'chenzhiming@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2024-05-10',
        'carType': '汽車',
        'parkingSpaceNum': 'B20-13',
        'name': '王美玲',
        'licensePlateNum': '9406-CP',
        'endDate': '2024-06-21',
        'remark': '-',
        'id': '17',
        'jobTitle': '專員',
        'ext': '678',
        'phone': '02-86719406',
        'email': 'wangmeiling@example.com',
        'building': '新德惠大樓',
    },
    {
        'paymentDate': '2025-06-29',
        'carType': '機車',
        'parkingSpaceNum': '7',
        'name': '林志豪',
        'licensePlateNum': '8-N012',
        'endDate': '2025-07-29',
        'remark': '-',
        'id': '18',
        'jobTitle': '經理',
        'ext': '901',
        'phone': '0912-344567',
        'email': 'linzhihao@example.com',
        'building': '校本部',
    },
    {
        'paymentDate': '2025-07-15',
        'carType': '汽車',
        'parkingSpaceNum': '20',
        'name': '楊惠君',
        'licensePlateNum': '1782-QR',
        'endDate': '2025-08-15',
        'remark': '-',
        'id': '19',
        'jobTitle': '主任',
        'ext': '234',
        'phone': '02-86711782',
        'email': 'yanghuijun@example.com',
        'building': '校本部',
    },
    {
        'paymentDate': '2024-05-09',
        'carType': '機車',
        'parkingSpaceNum': '12',
        'name': '陳建宏',
        'licensePlateNum': '5-H953',
        'endDate': '2024-06-09',
        'remark': '-',
        'id': '20',
        'jobTitle': '助理',
        'ext': '567',
        'phone': '0912-345678',
        'email': 'chenjianhong@example.com',
        'building': '校本部',
    }
];


$(function () {
    const today = new Date();
    dataset_myParkingSpaceHistory.forEach(item => {
        const endDate = new Date(item.endDate);
        const timeDiff = endDate.getTime() - today.getTime();
        const diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
        item.diffDays = diffDays < 0 ? null : ((-1) * diffDays);
        // console.log('id = ' + item.id + ' ，結束日期： ' + item.endDate + ' ，今日： 2024-06-18' + ' ，差： ' + item.diffDays);
    });

    $('#myParkingSpaceList').DataTable({
        ...commonSettingsProvision,
        layout: {
            topStart: function () {
                let provision = document.createElement('div');
                provision.innerHTML = '<h6 class="fw-bold"><i class="fa-solid fa-circle-exclamation mx-1"></i>若要續用，請於車位到期的5~45天前提出申請。</h6>';
                return provision;
            },
        },
        "data": dataset_myParkingSpaceHistory,
        "columns": [
            { data: 'paymentDate', title: "付款日", }, // 0
            { data: 'carType', title: "車位類型"}, // 1
            { data: 'building', title: "所在位置", }, // 2
            { data: 'parkingSpaceNum', title: "車位號碼", }, // 3
            { data: 'name', title: "登記使用人" }, // 4
            { data: 'licensePlateNum', title: "車牌號碼", }, // 5
            { data: 'endDate', title: "到期日", }, // 6
            { data: 'remark', title: "備註", }, // 7
            {
                data: 'id', title: "續約", // 8
                render: function (data, type, row) {
                    if (row.diffDays == null) {
                        return '<button type="button" class="btn btn-light rounded-circle btn-sm" title="續約時間已過"><i class="fa-solid fa-hourglass-end"></i></button>';
                    } else if (row.diffDays >= -45) {
                        return '<a class="btn btn-outline-primary rounded-circle btn-sm oneWord renew-btn" href="./parkingSpaceRenew.html?id=' + data + '" title="立即續約" data-id=' + data + '><i class="fa-solid fa-repeat"></i></a>';
                    } else {
                        return '<button type="button" class="btn btn-light rounded-circle btn-sm" title="續約時間未到"><i class="fa-solid fa-hourglass-half"></i></button>';
                    }
                },
            },
            { data: 'diffDays', visible: false }, // 9
        ],
        order: [[9, 'desc'], [6, 'asc']],
        "columnDefs": [
            {
                targets: [1],
                responsivePriority: 1,
            },
            {
                targets: [2],
                responsivePriority: 2,
            },
            {
                targets: [3],
                responsivePriority: 3,
            },
            { searchable: false, orderable: false, targets: [8, 9] },
            { className: "text-lg-center", targets: [0, 2, 3, 4, 5, 6, 8] },
            { className: "text-center", targets: [1, 3] },
        ],
        createdRow: function (row, data, dataIndex) {
            [0, 6].forEach(function (colIdx) {
                $('td:eq(' + colIdx + ')', row).css('font-size', '.95em').css('min-width', '130px');
            });
            [0, 1, 2, 3, 5, 6].forEach(function (colIdx) {
                $('td:eq(' + colIdx + ')', row).addClass('text-nowrap');
            });
            $('td:eq(7)', row).css('min-width', '200px').addClass('text-start');
            $('td:eq(8)', row).css('max-width', '70px');
        },
    });
});

$(function () {
    $(document).on("click", ".renew-btn", function (event) {
        event.preventDefault();
        const renewId = $(this).data('id');
        const renewLink = './parkingSpaceRenew.html?id=' + renewId;

        swalConfirmNoToastSandId(
            '登記使用人是否變更呢?',
            '是',
            '否',
            function () {
                window.location.href = renewLink;
            },
            '已將收款帳戶資訊發至貴司的主要聯絡信箱。<br><br>前往「進度查詢」：<br>可上傳匯款憑證，或是再次發送大同大學帳戶資訊。',
            'top',
            renewId);
    });
});
